{
  "hash": "f547883a554e1e9c6079a60ab7217b8e",
  "result": {
    "markdown": "---\ntitle: Visualizing time series data\nsubtitle: Lecture 8\ntitle-slide-attributes:\n  data-background-image: ../vizdata-bg.png\n  data-background-size: stretch\n  data-slide-number: none\nformat: revealjs\nhighlight-style: a11y\nexecute:\n  code-link: true\n  warning: true\neditor_options: \n  chunk_output_type: console\n---\n\n\n# Warm up\n\n## Announcements\n\n-   ...\n\n## Setup {.smaller}\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load packages\nlibrary(countdown)\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(janitor)\nlibrary(colorspace)\nlibrary(tidymodels)\n\n# set theme for ggplot2\nggplot2::theme_set(ggplot2::theme_minimal(base_size = 14))\n\n# set width of code output\noptions(width = 65)\n\n# set figure parameters for knitr\nknitr::opts_chunk$set(\n  fig.width = 7, # 7\" width\n  fig.asp = 0.618, # the golden ratio\n  fig.retina = 3, # dpi multiplier for displaying HTML output on retina\n  fig.align = \"center\", # center align figures\n  dpi = 300 # higher dpi, sharper image\n)\n```\n:::\n\n\n# Working with dates\n\n## Air Quality Index\n\n- The AQI is the Environmental Protection Agency's index for reporting air quality\n\n- Higher values of AQI indicate worse air quality\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](images/aqi-levels.png){fig-align='center' fig-alt='AQI Basics for Ozone and Particle Pollution' width=100%}\n:::\n:::\n\n\n::: aside\nSource: https://www.airnow.gov/aqi-basics\n:::\n\n## AQI levels\n\nThe previous graphic in tibble form, to be used later...\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\naqi_levels <- tribble(\n  ~aqi_min, ~aqi_max, ~color,    ~level,\n  0,        50,       \"#D8EEDA\", \"Good\",\n  51,       100,      \"#F1E7D4\", \"Moderate\",\n  101,      150,      \"#F8E4D8\", \"Unhealthy for sensitive groups\",\n  151,      200,      \"#FEE2E1\", \"Unhealthy\",\n  201,      300,      \"#F4E3F7\", \"Very unhealthy\",\n  301,      400,      \"#F9D0D4\", \"Hazardous\"\n)\n```\n:::\n\n\n## AQI data\n\n- Source: [EPA's  Daily Air Quality Tracker](https://www.epa.gov/outdoor-air-quality-data/air-data-daily-air-quality-tracker)\n\n- 2016 - 2022 AQI (Ozone and PM2.5 combined) for Durham-Chapel Hill, NC core-based statistical area (CBSA), one file per year\n\n- 2016 - 2022 AQI (Ozone and PM2.5 combined) for San Francisco-Oakland-Hayward, CA CBSA, one file per year\n\n## 2022 Durham-Chapel Hill\n\n- Load data\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch_2022 <- read_csv(here::here(\"data/durham-chapel-hill/ad_aqi_tracker_data-2022.csv\"))\n```\n:::\n\n\n. . .\n\n- Metadata\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndim(dch_2022)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 365  11\n```\n:::\n\n```{.r .cell-code}\nnames(dch_2022)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"Date\"                       \"AQI Value\"                 \n [3] \"Main Pollutant\"             \"Site Name\"                 \n [5] \"Site ID\"                    \"Source\"                    \n [7] \"20-year High (2000-2019)\"   \"20-year Low (2000-2019)\"   \n [9] \"5-year Average (2015-2019)\" \"Date of 20-year High\"      \n[11] \"Date of 20-year Low\"       \n```\n:::\n:::\n\n\n## Clean variable names\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch_2022 <- dch_2022 |>\n  janitor::clean_names()\n\nnames(dch_2022)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"date\"                      \"aqi_value\"                \n [3] \"main_pollutant\"            \"site_name\"                \n [5] \"site_id\"                   \"source\"                   \n [7] \"x20_year_high_2000_2019\"   \"x20_year_low_2000_2019\"   \n [9] \"x5_year_average_2015_2019\" \"date_of_20_year_high\"     \n[11] \"date_of_20_year_low\"      \n```\n:::\n:::\n\n\n## First look\n\n::: task\nThis plot looks quite bizarre. What might be going on?\n:::\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(dch_2022, aes(x = date, y = aqi_value, group = 1)) +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![](08-time-series_files/figure-revealjs/unnamed-chunk-8-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n\n## Peek at data\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch_2022 |>\n  select(date, aqi_value, site_name, site_id)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 365 × 4\n   date       aqi_value site_name     site_id    \n   <chr>      <chr>     <chr>         <chr>      \n 1 01/01/2022 22        Durham Armory 37-063-0015\n 2 01/02/2022 12        Durham Armory 37-063-0015\n 3 01/03/2022 10        Durham Armory 37-063-0015\n 4 01/04/2022 21        Durham Armory 37-063-0015\n 5 01/05/2022 35        Durham Armory 37-063-0015\n 6 01/06/2022 29        Durham Armory 37-063-0015\n 7 01/07/2022 15        Durham Armory 37-063-0015\n 8 01/08/2022 28        Durham Armory 37-063-0015\n 9 01/09/2022 28        Durham Armory 37-063-0015\n10 01/10/2022 15        Durham Armory 37-063-0015\n# … with 355 more rows\n```\n:::\n:::\n\n\n## Transforming date\n\nUsing `lubridate::mdy()`:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch_2022 |>\n  mutate(date = mdy(date))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 365 × 11\n   date       aqi_value main_pol…¹ site_…² site_id source x20_y…³\n   <date>     <chr>     <chr>      <chr>   <chr>   <chr>    <dbl>\n 1 2022-01-01 22        PM2.5      Durham… 37-063… AQS        111\n 2 2022-01-02 12        PM2.5      Durham… 37-063… AQS         76\n 3 2022-01-03 10        PM2.5      Durham… 37-063… AQS         66\n 4 2022-01-04 21        PM2.5      Durham… 37-063… AQS         61\n 5 2022-01-05 35        PM2.5      Durham… 37-063… AQS         83\n 6 2022-01-06 29        PM2.5      Durham… 37-063… AQS         71\n 7 2022-01-07 15        PM2.5      Durham… 37-063… AQS         75\n 8 2022-01-08 28        PM2.5      Durham… 37-063… AQS         76\n 9 2022-01-09 28        PM2.5      Durham… 37-063… AQS         57\n10 2022-01-10 15        PM2.5      Durham… 37-063… AQS         71\n# … with 355 more rows, 4 more variables:\n#   x20_year_low_2000_2019 <dbl>,\n#   x5_year_average_2015_2019 <dbl>, date_of_20_year_high <chr>,\n#   date_of_20_year_low <chr>, and abbreviated variable names\n#   ¹​main_pollutant, ²​site_name, ³​x20_year_high_2000_2019\n```\n:::\n:::\n\n\n## Transforming AQI values\n\n::: task\nWhat does this warning mean?\n:::\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch_2022 |>\n  mutate(aqi_value = as.numeric(aqi_value))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: There was 1 warning in `mutate()`.\nℹ In argument: `aqi_value = as.numeric(aqi_value)`.\nCaused by warning:\n! NAs introduced by coercion\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 365 × 11\n   date    aqi_v…¹ main_…² site_…³ site_id source x20_y…⁴ x20_y…⁵\n   <chr>     <dbl> <chr>   <chr>   <chr>   <chr>    <dbl>   <dbl>\n 1 01/01/…      22 PM2.5   Durham… 37-063… AQS        111      10\n 2 01/02/…      12 PM2.5   Durham… 37-063… AQS         76       8\n 3 01/03/…      10 PM2.5   Durham… 37-063… AQS         66      14\n 4 01/04/…      21 PM2.5   Durham… 37-063… AQS         61       9\n 5 01/05/…      35 PM2.5   Durham… 37-063… AQS         83       8\n 6 01/06/…      29 PM2.5   Durham… 37-063… AQS         71      15\n 7 01/07/…      15 PM2.5   Durham… 37-063… AQS         75      18\n 8 01/08/…      28 PM2.5   Durham… 37-063… AQS         76      15\n 9 01/09/…      28 PM2.5   Durham… 37-063… AQS         57      19\n10 01/10/…      15 PM2.5   Durham… 37-063… AQS         71      20\n# … with 355 more rows, 3 more variables:\n#   x5_year_average_2015_2019 <dbl>, date_of_20_year_high <chr>,\n#   date_of_20_year_low <chr>, and abbreviated variable names\n#   ¹​aqi_value, ²​main_pollutant, ³​site_name,\n#   ⁴​x20_year_high_2000_2019, ⁵​x20_year_low_2000_2019\n```\n:::\n:::\n\n\n## Investigating AQI values\n\n- Take a peek at distinct values of AQI\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch_2022 |>\n  distinct(aqi_value) |>\n  pull()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"22\" \"12\" \"10\" \"21\" \"35\" \"29\" \"15\" \"28\" \"25\" \"36\" \"49\" \"19\"\n[13] \"24\" \"46\" \"38\" \"48\" \"34\" \"47\" \"57\" \"26\" \"45\" \"42\" \"13\" \"31\"\n[25] \"39\" \"62\" \"40\" \"30\" \"20\" \"18\" \"27\" \"67\" \"41\" \"56\" \"37\" \"32\"\n[37] \"43\" \"51\" \"50\" \"44\" \"33\" \"54\" \"52\" \"77\" \"74\" \"53\" \"58\" \"64\"\n[49] \"61\" \"93\" \"16\" \"17\" \"23\" \"5\"  \"6\"  \".\"  \"9\"  \"14\" \"59\"\n```\n:::\n:::\n\n\n- `\".\"` likely indicates `NA`, and it's causing the entire column to be read in as characters\n\n## Rewind, and start over\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch_2022 <- read_csv(\n  here::here(\"data/durham-chapel-hill/ad_aqi_tracker_data-2022.csv\"),\n  na = c(\".\", \"\")\n)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nglimpse(dch_2022)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 365\nColumns: 11\n$ Date                         <chr> \"01/01/2022\", \"01/02/2022\"…\n$ `AQI Value`                  <dbl> 22, 12, 10, 21, 35, 29, 15…\n$ `Main Pollutant`             <chr> \"PM2.5\", \"PM2.5\", \"PM2.5\",…\n$ `Site Name`                  <chr> \"Durham Armory\", \"Durham A…\n$ `Site ID`                    <chr> \"37-063-0015\", \"37-063-001…\n$ Source                       <chr> \"AQS\", \"AQS\", \"AQS\", \"AQS\"…\n$ `20-year High (2000-2019)`   <dbl> 111, 76, 66, 61, 83, 71, 7…\n$ `20-year Low (2000-2019)`    <dbl> 10, 8, 14, 9, 8, 15, 18, 1…\n$ `5-year Average (2015-2019)` <dbl> 39.2, 36.8, 38.2, 30.4, 26…\n$ `Date of 20-year High`       <chr> \"01/01/2000\", \"01/02/2005\"…\n$ `Date of 20-year Low`        <chr> \"01/01/2007\", \"01/02/2012\"…\n```\n:::\n:::\n\n\n## Data cleaning\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch_2022 <- dch_2022 |>\n  janitor::clean_names() |>\n  mutate(date = mdy(date))\n\ndch_2022\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 365 × 11\n   date       aqi_value main_pol…¹ site_…² site_id source x20_y…³\n   <date>         <dbl> <chr>      <chr>   <chr>   <chr>    <dbl>\n 1 2022-01-01        22 PM2.5      Durham… 37-063… AQS        111\n 2 2022-01-02        12 PM2.5      Durham… 37-063… AQS         76\n 3 2022-01-03        10 PM2.5      Durham… 37-063… AQS         66\n 4 2022-01-04        21 PM2.5      Durham… 37-063… AQS         61\n 5 2022-01-05        35 PM2.5      Durham… 37-063… AQS         83\n 6 2022-01-06        29 PM2.5      Durham… 37-063… AQS         71\n 7 2022-01-07        15 PM2.5      Durham… 37-063… AQS         75\n 8 2022-01-08        28 PM2.5      Durham… 37-063… AQS         76\n 9 2022-01-09        28 PM2.5      Durham… 37-063… AQS         57\n10 2022-01-10        15 PM2.5      Durham… 37-063… AQS         71\n# … with 355 more rows, 4 more variables:\n#   x20_year_low_2000_2019 <dbl>,\n#   x5_year_average_2015_2019 <dbl>, date_of_20_year_high <chr>,\n#   date_of_20_year_low <chr>, and abbreviated variable names\n#   ¹​main_pollutant, ²​site_name, ³​x20_year_high_2000_2019\n```\n:::\n:::\n\n\n## Another look\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(dch_2022, aes(x = date, y = aqi_value, group = 1)) +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![](08-time-series_files/figure-revealjs/dch-2022-1-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n::: task\nHow would you improve this visualization?\n:::\n\n::: panel-tabset\n### Plot\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-time-series_files/figure-revealjs/unnamed-chunk-18-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n### Discuss\nTO DO: Add Slido\n:::\n\n## Livecoding\n\n::: task\nRecreate the following visualization.\n:::\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-time-series_files/figure-revealjs/dch-2022-2-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n\n## Livecoding\n\n::: task\nRecreate the following visualization.\n:::\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-time-series_files/figure-revealjs/dch-2022-3-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n## Highlights\n\n- The **lubridate** package is useful for converting to dates from character strings in a given format, e.g. `mdy()`, `ymd()`, etc.\n\n- The **colorspace** package is useful for programmatically darkening / lightening colors\n\n- `scale_x_date`: Set `date_labels` as `\"%b %y\"` for month-2 digit year, `\"%D\"` for date format such as `%m/%d/%y`, etc. See help for `strptime()` for more.\n\n- `scale_color_identity()` or `scale_fill_identity()` can be useful when your data already represents aesthetic values that ggplot2 can handle directly. By default doesn't produce  a legend.\n\n# Calculating cumulatives\n\n## Cumulatives over time\n\n- When visualizing time series data, a somewhat common task is to calculate cumulatives over time and plot them\n\n- In our example we'll calculate the number of days with \"good\" AQI ($\\le$ 50) and plot that value on the y-axis and the date on the x-axis\n\n## Calculating cumulatives\n\nStep 1. Arrange your data\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch_2022 |>\n  select(date, aqi_value) |>\n  filter(!is.na(aqi_value)) |>\n  arrange(date)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 364 × 2\n   date       aqi_value\n   <date>         <dbl>\n 1 2022-01-01        22\n 2 2022-01-02        12\n 3 2022-01-03        10\n 4 2022-01-04        21\n 5 2022-01-05        35\n 6 2022-01-06        29\n 7 2022-01-07        15\n 8 2022-01-08        28\n 9 2022-01-09        28\n10 2022-01-10        15\n# … with 354 more rows\n```\n:::\n:::\n\n\n## Calculating cumulatives\n\nStep 2. Identify good days\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch_2022 |>\n  select(date, aqi_value) |>\n  filter(!is.na(aqi_value)) |>\n  arrange(date) |>\n  mutate(good_aqi = if_else(aqi_value <= 50, 1, 0))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 364 × 3\n   date       aqi_value good_aqi\n   <date>         <dbl>    <dbl>\n 1 2022-01-01        22        1\n 2 2022-01-02        12        1\n 3 2022-01-03        10        1\n 4 2022-01-04        21        1\n 5 2022-01-05        35        1\n 6 2022-01-06        29        1\n 7 2022-01-07        15        1\n 8 2022-01-08        28        1\n 9 2022-01-09        28        1\n10 2022-01-10        15        1\n# … with 354 more rows\n```\n:::\n:::\n\n\n## Calculating cumulatives\n\nStep 3. Sum over time\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch_2022 |>\n  select(date, aqi_value) |>\n  filter(!is.na(aqi_value)) |>\n  arrange(date) |>\n  mutate(\n    good_aqi = if_else(aqi_value <= 50, 1, 0),\n    cum_good_aqi = cumsum(good_aqi)\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 364 × 4\n   date       aqi_value good_aqi cum_good_aqi\n   <date>         <dbl>    <dbl>        <dbl>\n 1 2022-01-01        22        1            1\n 2 2022-01-02        12        1            2\n 3 2022-01-03        10        1            3\n 4 2022-01-04        21        1            4\n 5 2022-01-05        35        1            5\n 6 2022-01-06        29        1            6\n 7 2022-01-07        15        1            7\n 8 2022-01-08        28        1            8\n 9 2022-01-09        28        1            9\n10 2022-01-10        15        1           10\n# … with 354 more rows\n```\n:::\n:::\n\n\n## Plotting cumulatives\n\n::: panel-tabset\n### Plot\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-time-series_files/figure-revealjs/durham-aqi-3-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n### Code\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch_2022 |>\n  select(date, aqi_value) |>\n  filter(!is.na(aqi_value)) |>\n  arrange(date) |>\n  mutate(\n    good_aqi = if_else(aqi_value <= 50, 1, 0),\n    cum_good_aqi = cumsum(good_aqi)\n  ) |>\n  ggplot(aes(x = date, y = cum_good_aqi, group = 1)) +\n  geom_line() +\n  scale_x_date(date_labels = \"%b %Y\") +\n  labs(\n    x = NULL, y = \"Number of days\",\n    title = \"Cumulative number of good AQI days (AQI < 50)\",\n    subtitle = \"Durham-Chapel Hill, NC\",\n    caption = \"\\nSource: EPA Daily Air Quality Tracker\"\n  ) +\n  theme(plot.title.position = \"plot\")\n```\n:::\n\n:::\n\n# Detrending\n\n## Detrending\n\n- Detrending is removing prominent long-term trend in time series to specifically highlight any notable deviations\n\n- Let's demonstrate using multiple years of AQI data\n\n## Read in multiple years of Durham-Chapel Hill data {.smaller}\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch_files <- fs::dir_ls(here::here(\"data/durham-chapel-hill\"))\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch <- read_csv(dch_files, na = c(\".\", \"\"))\n\ndch <- dch |>\n  janitor::clean_names() |>\n  mutate(\n    date = mdy(date),\n    good_aqi = if_else(aqi_value <= 50, 1, 0)\n  ) |>\n  filter(!is.na(aqi_value)) |>\n  arrange(date) |>\n  mutate(cum_good_aqi = cumsum(good_aqi), .after = aqi_value)\n\ndch\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2,547 × 13\n   date       aqi_value cum_good…¹ main_…² site_…³ site_id source\n   <date>         <dbl>      <dbl> <chr>   <chr>   <chr>   <chr> \n 1 2016-01-01        32          1 PM2.5   Durham… 37-063… AQS   \n 2 2016-01-02        37          2 PM2.5   Durham… 37-063… AQS   \n 3 2016-01-03        45          3 PM2.5   Durham… 37-063… AQS   \n 4 2016-01-04        33          4 PM2.5   Durham… 37-063… AQS   \n 5 2016-01-05        27          5 PM2.5   Durham… 37-063… AQS   \n 6 2016-01-06        39          6 PM2.5   Durham… 37-063… AQS   \n 7 2016-01-07        39          7 PM2.5   Durham… 37-063… AQS   \n 8 2016-01-08        31          8 PM2.5   Durham… 37-063… AQS   \n 9 2016-01-09        20          9 PM2.5   Durham… 37-063… AQS   \n10 2016-01-10        20         10 PM2.5   Durham… 37-063… AQS   \n# … with 2,537 more rows, 6 more variables:\n#   x20_year_high_2000_2019 <dbl>, x20_year_low_2000_2019 <dbl>,\n#   x5_year_average_2015_2019 <dbl>, date_of_20_year_high <chr>,\n#   date_of_20_year_low <chr>, good_aqi <dbl>, and abbreviated\n#   variable names ¹​cum_good_aqi, ²​main_pollutant, ³​site_name\n```\n:::\n:::\n\n\n## Plot trend since 2016\n\n::: panel-tabset\n### Plot\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](08-time-series_files/figure-revealjs/dch-3-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n### Code\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch |>\n  ggplot(aes(x = date, y = cum_good_aqi, group = 1)) +\n  geom_smooth(method = \"lm\", color = \"pink\") +\n  geom_line() +\n  scale_x_date(\n    expand = expansion(mult = 0.07),\n    date_labels = \"%Y\"\n  ) +\n  labs(\n    x = NULL, y = \"Number of days\",\n    title = \"Cumulative number of good AQI days (AQI < 50)\",\n    subtitle = \"Durham-Chapel Hill, NC\",\n    caption = \"\\nSource: EPA Daily Air Quality Tracker\"\n  ) +\n  theme(plot.title.position = \"plot\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n:::\n\n:::\n\n## Detrend\n\nStep 1. Fit a simple linear regression\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nm <- lm(cum_good_aqi ~ date, data = dch)\n\nm\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = cum_good_aqi ~ date, data = dch)\n\nCoefficients:\n(Intercept)         date  \n -1.341e+04    7.954e-01  \n```\n:::\n:::\n\n\n## Detrend\n\nStep 2. Augment the data with model results (using `broom::augment()`)\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch_aug <- augment(m)\n\ndch_aug\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2,547 × 8\n   cum_good_aqi date       .fitted .resid    .hat .sigma .cooksd\n          <dbl> <date>       <dbl>  <dbl>   <dbl>  <dbl>   <dbl>\n 1            1 2016-01-01   -42.8   43.8 0.00157   25.4 0.00234\n 2            2 2016-01-02   -42.0   44.0 0.00157   25.4 0.00236\n 3            3 2016-01-03   -41.3   44.3 0.00156   25.4 0.00238\n 4            4 2016-01-04   -40.5   44.5 0.00156   25.4 0.00240\n 5            5 2016-01-05   -39.7   44.7 0.00156   25.4 0.00242\n 6            6 2016-01-06   -38.9   44.9 0.00156   25.4 0.00244\n 7            7 2016-01-07   -38.1   45.1 0.00156   25.4 0.00246\n 8            8 2016-01-08   -37.3   45.3 0.00155   25.4 0.00248\n 9            9 2016-01-09   -36.5   45.5 0.00155   25.4 0.00250\n10           10 2016-01-10   -35.7   45.7 0.00155   25.4 0.00252\n# … with 2,537 more rows, and 1 more variable: .std.resid <dbl>\n```\n:::\n:::\n\n\n## Detrend\n\nStep 3. Divide the observed value of `cum_good_aqi` by the respective value in the long-term trend (i.e., `.fitted`)\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch_aug <- dch_aug |>\n  mutate(ratio = cum_good_aqi / .fitted, .after = .fitted)\n\n\ndch_aug\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2,547 × 9\n   cum_good_aqi date       .fitted   ratio .resid    .hat .sigma\n          <dbl> <date>       <dbl>   <dbl>  <dbl>   <dbl>  <dbl>\n 1            1 2016-01-01   -42.8 -0.0233   43.8 0.00157   25.4\n 2            2 2016-01-02   -42.0 -0.0476   44.0 0.00157   25.4\n 3            3 2016-01-03   -41.3 -0.0727   44.3 0.00156   25.4\n 4            4 2016-01-04   -40.5 -0.0989   44.5 0.00156   25.4\n 5            5 2016-01-05   -39.7 -0.126    44.7 0.00156   25.4\n 6            6 2016-01-06   -38.9 -0.154    44.9 0.00156   25.4\n 7            7 2016-01-07   -38.1 -0.184    45.1 0.00156   25.4\n 8            8 2016-01-08   -37.3 -0.215    45.3 0.00155   25.4\n 9            9 2016-01-09   -36.5 -0.247    45.5 0.00155   25.4\n10           10 2016-01-10   -35.7 -0.280    45.7 0.00155   25.4\n# … with 2,537 more rows, and 2 more variables: .cooksd <dbl>,\n#   .std.resid <dbl>\n```\n:::\n:::\n\n\n## Visualize detrended data\n\n::: panel-tabset\n### Plot\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-time-series_files/figure-revealjs/dch-4-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n### Code\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndch_aug |>\n  ggplot(aes(x = date, y = ratio, group = 1)) +\n  geom_hline(yintercept = 1, color = \"gray\") +\n  geom_line() +\n  scale_x_date(\n    expand = expansion(mult = 0.07),\n    date_labels = \"%Y\"\n  ) +\n  labs(\n    x = NULL, y = \"Number of days (detrended)\",\n    title = \"Cumulative number of good AQI days (AQI < 50)\",\n    subtitle = \"Durham-Chapel Hill, NC\",\n    caption = \"\\nSource: EPA Daily Air Quality Tracker\"\n  ) +\n  theme(plot.title.position = \"plot\")\n```\n:::\n\n:::\n\n## Air Quality in Durham\n\n::: hand\nbarely anything interesting happening!\n:::\n\n. . .\n\n::: hand\nlet's look at data from somewhere with a bit more \"interesting\" air quality data...\n:::\n\n## Read in multiple years of SF data {.smaller}\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsf_files <- fs::dir_ls(here::here(\"data/san-francisco\"))\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsf <- read_csv(sf_files, na = c(\".\", \"\"))\n\nsf <- sf |>\n  janitor::clean_names() |>\n  mutate(\n    date = mdy(date),\n    good_aqi = if_else(aqi_value <= 50, 1, 0)\n  ) |>\n  filter(!is.na(aqi_value)) |>\n  arrange(date) |>\n  mutate(cum_good_aqi = cumsum(good_aqi), .after = aqi_value)\n\nsf\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2,557 × 13\n   date       aqi_value cum_good…¹ main_…² site_…³ site_id source\n   <date>         <dbl>      <dbl> <chr>   <chr>   <chr>   <chr> \n 1 2016-01-01        32          1 PM2.5   Durham… 37-063… AQS   \n 2 2016-01-02        37          2 PM2.5   Durham… 37-063… AQS   \n 3 2016-01-03        45          3 PM2.5   Durham… 37-063… AQS   \n 4 2016-01-04        33          4 PM2.5   Durham… 37-063… AQS   \n 5 2016-01-05        27          5 PM2.5   Durham… 37-063… AQS   \n 6 2016-01-06        39          6 PM2.5   Durham… 37-063… AQS   \n 7 2016-01-07        39          7 PM2.5   Durham… 37-063… AQS   \n 8 2016-01-08        31          8 PM2.5   Durham… 37-063… AQS   \n 9 2016-01-09        20          9 PM2.5   Durham… 37-063… AQS   \n10 2016-01-10        20         10 PM2.5   Durham… 37-063… AQS   \n# … with 2,547 more rows, 6 more variables:\n#   x20_year_high_2000_2019 <dbl>, x20_year_low_2000_2019 <dbl>,\n#   x5_year_average_2015_2019 <dbl>, date_of_20_year_high <chr>,\n#   date_of_20_year_low <chr>, good_aqi <dbl>, and abbreviated\n#   variable names ¹​cum_good_aqi, ²​main_pollutant, ³​site_name\n```\n:::\n:::\n\n\n## Plot trend since 2016\n\n::: panel-tabset\n### Plot\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](08-time-series_files/figure-revealjs/sf-1-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n### Code\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsf |>\n  ggplot(aes(x = date, y = cum_good_aqi, group = 1)) +\n  geom_smooth(method = \"lm\", color = \"pink\") +\n  geom_line() +\n  scale_x_date(\n    expand = expansion(mult = 0.07),\n    date_labels = \"%Y\"\n  ) +\n  labs(\n    x = NULL, y = \"Number of days\",\n    title = \"Cumulative number of good AQI days (AQI < 50)\",\n    subtitle = \"San Francisco-Oakland-Hayward, CA\",\n    caption = \"\\nSource: EPA Daily Air Quality Tracker\"\n  ) +\n  theme(plot.title.position = \"plot\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n:::\n\n:::\n\n## Detrend\n\n1. Fit a simple linear regression\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nm_sf <- lm(cum_good_aqi ~ date, data = sf)\n```\n:::\n\n\n. . .\n\n2. Augment the data with model results\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsf_aug <- augment(m_sf)\n```\n:::\n\n\n. . .\n\n3. Divide the observed value of `cum_good_aqi` by the respective value in the long-term trend (i.e., `.fitted`)\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsf_aug <- sf_aug |>\n  mutate(ratio = cum_good_aqi / .fitted, .after = .fitted)\n```\n:::\n\n\n## Visualize detrended data\n\n::: panel-tabset\n### Plot\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-time-series_files/figure-revealjs/sf-2-1.png){fig-align='center' width=2100}\n:::\n:::\n\n\n### Code\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsf_aug |>\n  ggplot(aes(x = date, y = ratio, group = 1)) +\n  geom_hline(yintercept = 1, color = \"gray\") +\n  geom_line() +\n  scale_x_date(\n    expand = expansion(mult = 0.07),\n    date_labels = \"%Y\"\n  ) +\n  labs(\n    x = NULL, y = \"Number of days (detrended)\",\n    title = \"Cumulative number of good AQI days (AQI < 50)\",\n    subtitle = \"San Francisco-Oakland-Hayward, CA\",\n    caption = \"\\nSource: EPA Daily Air Quality Tracker\"\n  ) +\n  theme(plot.title.position = \"plot\")\n```\n:::\n\n:::\n\n## Detrending\n\n- In step 2 we fit a very simple model\n\n- Depending on the complexity you're trying to capture you might choose to fit a much more complex model\n\n- You can also decompose the trend into multiple trends, e.g. monthly, long-term, seasonal, etc.\n\n::: aside\nInterested in learning more? Take STA 344 - Spatio-temporal analysis!\n:::\n",
    "supporting": [
      "08-time-series_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}